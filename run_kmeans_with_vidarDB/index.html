<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <meta name="author" content="VidarDB Team">
  <link rel="shortcut icon" href="../img/favicon.ico">
  <title>Run KMeans with VidarDB - VidarDB</title>
  <link href='https://fonts.googleapis.com/css?family=Lato:400,700|Roboto+Slab:400,700|Inconsolata:400,700' rel='stylesheet' type='text/css'>

  <link rel="stylesheet" href="../css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../css/theme_extra.css" type="text/css" />
  <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/github.min.css">
  
  <script>
    // Current page data
    var mkdocs_page_name = "Run KMeans with VidarDB";
    var mkdocs_page_input_path = "run_kmeans_with_vidarDB.md";
    var mkdocs_page_url = null;
  </script>
  
  <script src="../js/jquery-2.1.1.min.js" defer></script>
  <script src="../js/modernizr-2.8.3.min.js" defer></script>
  <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js"></script>
  <script>hljs.initHighlightingOnLoad();</script> 
  
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
      <div class="wy-side-nav-search">
        <a href=".." class="icon icon-home"> VidarDB</a>
        <div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" title="Type search term here" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
	<ul class="current">
	  
          
            <li class="toctree-l1">
		
    <a class="" href="..">Welcome to VidarDB</a>
	    </li>
          
            <li class="toctree-l1">
		
    <a class="" href="../what_is_vidarDB/">What is VidarDB</a>
	    </li>
          
            <li class="toctree-l1">
		
    <a class="" href="../run_vidarDB_with_docker/">Run VidarDB with Docker</a>
	    </li>
          
            <li class="toctree-l1">
		
    <a class="" href="../example/">VidarDB Examples</a>
	    </li>
          
            <li class="toctree-l1 current">
		
    <a class="current" href="./">Run KMeans with VidarDB</a>
    <ul class="subnav">
            
    <li class="toctree-l2"><a href="#run-kmeans-with-vidardb">Run KMeans with VidarDB</a></li>
    
        <ul>
        
            <li><a class="toctree-l3" href="#preparation">Preparation</a></li>
        
            <li><a class="toctree-l3" href="#data-training">Data Training</a></li>
        
            <li><a class="toctree-l3" href="#perform-clustering-predictions">Perform Clustering Predictions</a></li>
        
            <li><a class="toctree-l3" href="#reference">Reference</a></li>
        
        </ul>
    

    </ul>
	    </li>
          
            <li class="toctree-l1">
		
    <a class="" href="../faq/">Frequently Asked Questions</a>
	    </li>
          
        </ul>
      </div>
      &nbsp;
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
        <a href="..">VidarDB</a>
      </nav>

      
      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="..">Docs</a> &raquo;</li>
    
      
    
    <li>Run KMeans with VidarDB</li>
    <li class="wy-breadcrumbs-aside">
      
        <a href="https://github.com/vidardb/docs/edit/master/docs/run_kmeans_with_vidarDB.md"
          class="icon icon-github"> Edit on GitHub</a>
      
    </li>
  </ul>
  <hr/>
</div>
          <div role="main">
            <div class="section">
              
                <h1 id="run-kmeans-with-vidardb">Run KMeans with VidarDB</h1>
<p>VidarDB natively supports AI, which is built on <a href="https://madlib.apache.org/index.html">MADlib</a> allowing you to perfrom various commonly-used AI algorithms in SQL easily. This page gives you a good example of using KMeans clustering algorithm to train data in VidarDB. It assumes VidarDB is already installed. If not, please head over to the <a href="../run_vidarDB_with_docker/">Run VidarDB with Docker</a> section.</p>
<h2 id="preparation">Preparation</h2>
<p>Make sure <code>psql</code> is installed on your computer. If not, for Debian users:  </p>
<pre><code class="bash">sudo apt-get install postgresql-client
</code></pre>

<p>Clone and go into the VidarDB's util repository:</p>
<pre><code class="sh">git clone https://github.com/vidardb/util.git &amp;&amp; cd util
</code></pre>

<p>Import Chicago Taxi Trips data:</p>
<pre><code class="sh">cd ./util-notebook/kmeans/ &amp;&amp; psql -h 127.0.0.1 -p 5432 -U postgres -f ./import-data_chicago_taxi_trips.sql
</code></pre>

<p>This will also create a new database called <code>chicago_taxi_trips</code>.</p>
<p>Then, create a new table <code>chicago_taxi_trips_change</code> for the data training:</p>
<pre><code class="sql">-- connect to the local vidardb
psql -h 127.0.0.1 -p 5432 -U postgres

-- connect to the database
\c chicago_taxi_trips postgres;

-- create new table
DROP TABLE IF EXISTS chicago_taxi_trips_change;

-- double precision array for (pickup_latitude,pickup_longitude)
CREATE TABLE chicago_taxi_trips_change
(
    row_id SERIAL,
    taxi_id INT,
    pickup_latitude DECIMAL(10, 2),
    pickup_longitude DECIMAL(10, 2),
    row_vec DOUBLE PRECISION[]
);

-- insert data
INSERT INTO chicago_taxi_trips_change (taxi_id,pickup_latitude,pickup_longitude, row_vec)
SELECT taxi_id,
       pickup_latitude,
       pickup_longitude,
       array_cat(array[pickup_latitude], array[pickup_longitude])
FROM chicago_taxi_trips;
</code></pre>

<p>Now, the preparation is done. Let's move to the training part.</p>
<h2 id="data-training">Data Training</h2>
<p>This section is very simple and straightforward. Before training data, we need to enable AI support in <code>chicago_taxi_trips</code> database:</p>
<pre><code class="shell">docker exec -it vidardb sh -c &quot;install-madlib.sh -U postgres -D chicago_taxi_trips&quot;
</code></pre>

<p>Try the following SQL commands to train data with KMeans:</p>
<pre><code class="sql">-- connect to the local vidardb
psql -h 127.0.0.1 -p 5432 -U postgres

-- connect to the database
\c chicago_taxi_trips postgres;

-- create new table
DROP TABLE IF EXISTS km_result;

-- run kmeans algorithm
CREATE TABLE km_result AS
SELECT * FROM madlib.kmeanspp(
    'chicago_taxi_trips_change',   -- Table of source data
    'row_vec',                     -- Column containing point co-ordinates 
    5,                             -- Number of centroids to calculate
    'madlib.squared_dist_norm2',   -- Distance function
    'madlib.avg',                  -- Aggregate function
    20,                            -- Number of iterations
    0.001                          -- Fraction of centroids reassigned to keep iterating 
    );
</code></pre>

<h2 id="perform-clustering-predictions">Perform Clustering Predictions</h2>
<p>Predict the cluster_id of each trip with the model we have just trained:</p>
<pre><code class="sql">SELECT trips_data.*, (madlib.closest_column(centroids, row_vec)).column_id AS cluster_id
    FROM chicago_taxi_trips_change AS trips_data, km_result
    ORDER BY trips_data.row_id DESC LIMIT 10;
</code></pre>

<p>We can get some results like this:</p>
<pre><code> row_id | taxi_id | pickup_latitude | pickup_longitude |           row_vec            | cluster_id 
--------+---------+-----------------+------------------+------------------------------+------------
    999 |    7040 |           41.88 |           -87.63 | {41.880994471,-87.632746489} |          1
    998 |    7145 |           41.88 |           -87.64 | {41.879255084,-87.642648998} |          1
    997 |    7864 |           41.79 |           -87.75 | {41.785998518,-87.750934289} |          3
    996 |    6620 |           41.90 |           -87.62 | {41.89503345,-87.619710672}  |          0
    995 |     393 |           41.89 |           -87.63 | {41.892072635,-87.628874157} |          0
    994 |    1082 |           41.89 |           -87.62 | {41.890922026,-87.618868355} |          0
    993 |      55 |           41.88 |           -87.63 | {41.880994471,-87.632746489} |          1
    992 |    7749 |           41.89 |           -87.63 | {41.892042136,-87.63186395}  |          0
    991 |    7564 |           41.88 |           -87.62 | {41.884987192,-87.620992913} |          0
    990 |    7065 |           41.89 |           -87.63 | {41.892507781,-87.626214906} |          0
</code></pre>

<h2 id="reference">Reference</h2>
<p>The data this example used come from <a href="https://data.cityofchicago.org/Transportation/Taxi-Trips/wrvz-psew">Taxi Trips | City of Chicago | Data Portal</a>.</p>
<p>(More examples will come soon!)</p>
              
            </div>
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="../faq/" class="btn btn-neutral float-right" title="Frequently Asked Questions">Next <span class="icon icon-circle-arrow-right"></span></a>
      
      
        <a href="../example/" class="btn btn-neutral" title="VidarDB Examples"><span class="icon icon-circle-arrow-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
    
      <p>2020 VidarDB Inc. All Rights Reserved.</p>
    
  </div>

  Built with <a href="http://www.mkdocs.org">MkDocs</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
      
        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" style="cursor: pointer">
    <span class="rst-current-version" data-toggle="rst-current-version">
      
          <a href="https://github.com/vidardb/docs/" class="fa fa-github" style="float: left; color: #fcfcfc"> GitHub</a>
      
      
        <span><a href="../example/" style="color: #fcfcfc;">&laquo; Previous</a></span>
      
      
        <span style="margin-left: 15px"><a href="../faq/" style="color: #fcfcfc">Next &raquo;</a></span>
      
    </span>
</div>
    <script>var base_url = '..';</script>
    <script src="../js/theme.js" defer></script>
      <script src="../search/main.js" defer></script>

</body>
</html>
